---
alwaysApply: true
---

# Tech Stack

## Core Framework

- **Next.js 16**: App Router architecture, Server Components by default
- **React 19**: Latest React with React Compiler enabled
- **TypeScript 5**: Strict type checking throughout

## Database & ORM

- **PostgreSQL**: Primary database
- **Prisma 6**: ORM with type-safe database access
- **Database Schema**: 
  - Core: User, Chat (with lastStatus/lastError), ChatMessage
  - Tools: App, Class, Method
  - Vector: AppData, ClassData, MethodData (embeddings)

## UI & Styling

- **shadcn/ui**: Component library built on Radix UI
- **Tailwind CSS 4**: Utility-first styling
- **next-themes**: Theme management with system detection and persistence
- **Components**: Button, Input, Card, ScrollArea, Avatar, Dialog, Table

## AI & API

- **OpenAI SDK**: Chat completions, embeddings, tool execution
  - **Centralized model config** (`lib/model-config.ts`):
    - Two tiers: "fast" (gpt-3.5) and "normal" (gpt-4o)
    - Automatic parameter handling for different model families
    - Context window, max tokens, temperature auto-configured
  - **Current default (fast tier)**:
    - gpt-3.5-turbo: All chat, tool selection, and processing
    - text-embedding-3-small: Vector embeddings (1536 dimensions)
  - **Normal tier**:
    - gpt-4o: Main chat, tool selector, META_TOOLS
    - gpt-4o-mini: Utility scripts, query summarization
    - gpt-3.5-turbo: Tool wrapper processing
  - **Model families supported**:
    - GPT-3.5: 16k context, fast, cheap
    - GPT-4o: 128k context, balanced
    - GPT-4o-mini: 128k context, cheaper variant
    - GPT-5: 200k context (currently avoided - too slow)
- **Zod**: Runtime type validation for server actions
- **pgvector**: PostgreSQL extension for vector similarity search
  - HNSW indexes for efficient cosine similarity
  - Stores embeddings for apps, classes, methods

## Development Tools

- **ESLint**: Code linting with Next.js config
- **Prettier**: Code formatting
- **TypeScript**: Static type checking
- **Node.js vm module**: Isolated execution context for REPL environment

## Architecture Patterns

### Server Actions
- All data mutations use Server Actions (`"use server"`)
- Type-safe with Zod validation
- Located in `app/actions/`

### Client Components
- Only used for interactive UI (forms, localStorage access)
- Marked with `"use client"` directive
- Minimal client-side logic

### Data Flow
- Server Components fetch data directly
- Client Components call Server Actions for mutations
- Async processing with `setImmediate()` for non-blocking operations
- Optimistic UI updates for instant feedback
- Polling for real-time status updates (5s for active chat, 10s for chat list)
- Delayed refreshes (500ms) to prevent request cascades
- Prisma Client singleton pattern in `lib/prisma.ts`

### User Identification
- Device-based: `deviceKey` stored in localStorage
- No authentication system
- User created/retrieved via device key

### Tool Selection System (IPC-based REPL)
- Iterative LLM-driven code generation and execution
- Real Node.js child process via IPC (no code transformations)
- Variables persist naturally across iterations
- META_TOOLS execute in parent via IPC (single Prisma connection)
- Located in `lib/tool-selector.ts` and `lib/repl/`
- Max 10 iterations, often completes in 1-4 steps
- Returns 0 tools immediately for conversational queries

### Tool Wrapper System
- Two-tier LLM architecture (gpt-4 + gpt-3.5)
- Main model never sees raw tool results
- gpt-3.5-turbo processes all tool outputs
- Single natural language `query` parameter per tool
- Located in `lib/tool-wrapper.ts`

### RAG Vector Search
- Embeddings stored in separate *_data tables
- pgvector with HNSW indexes for fast similarity search
- Cosine distance operator (<=>)
- Threshold: 0.5 for relevant results
- Located in `lib/meta-tools/vector-search.ts`

## Deployment

- **Vercel**: Target deployment platform
- **Environment Variables**: DATABASE_URL, OPENAI_API_KEY

## Key Dependencies

```json
{
  "next": "16.0.3",
  "react": "19.2.0",
  "@prisma/client": "^6.19.0",
  "openai": "^6.9.0",
  "zod": "^4.1.12",
  "next-themes": "^0.4.4"
}
```

## File Structure Conventions

- `app/`: Next.js App Router pages and routes
- `app/actions/`: Server Actions (chat, tools, user, vectors)
  - `chat.ts`: Async message processing, status tracking, polling endpoints
- `components/`: React components (UI and feature components)
  - `components/chat/`: Chat UI (chat-list, chat-history, chat-input, status icons)
- `lib/`: Utility functions and services
  - `lib/chat-context.tsx`: Chat list state, optimistic updates, single chat refresh
  - `lib/theme-provider.tsx`: Dark mode theme provider (next-themes wrapper)
  - `lib/repl/`: Persistent REPL execution environment (ReplSession, tools)
  - `lib/meta-tools/`: META_TOOLS implementations (RAG + LLM)
  - `lib/tool-selector.ts`: ReAct loop for tool selection
  - `lib/tool-wrapper.ts`: LLM wrapper for tool execution
  - `lib/chat-service.ts`: Main chat orchestration
  - `lib/embedding-service.ts`: OpenAI embeddings
  - `lib/vector-service.ts`: Vector data population
- `types/`: TypeScript type definitions
  - `chat.ts`: Chat types with lastStatus/lastError fields
- `prisma/`: Database schema and migrations
- `prisma/seed.ts`: Database seeding script with LLM-powered tool generation
- `scripts/`: Utility scripts and test tools
  - `populate-vectors.ts`: Generate embeddings for all tools
  - `test-chat.ts`: End-to-end chat flow testing
  - `test-similarity.ts`: Vector similarity analysis
  - `test-vector-flow.ts`: Step-by-step vector search validation
  - `check-db.ts`: Database content inspection
  - All test scripts use dotenv for environment variable loading
- `.cursor/rules/`: Cursor AI documentation (*.mdc files)
